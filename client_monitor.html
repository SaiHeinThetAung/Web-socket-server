<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ship Locations</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Ship Locations</h1>
    <div id="status" class="mb-4 text-lg font-semibold text-gray-700">Connecting to WebSocket...</div>
    <div class="overflow-x-auto bg-white shadow-md rounded-lg">
      <table id="shipTable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ship ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GPS</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Latitude</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Longitude</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Altitude</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Speed</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heading</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Satellites</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device ID</th>
          </tr>
        </thead>
        <tbody id="shipTableBody" class="bg-white divide-y divide-gray-200">
          <tr>
            <td colspan="10" class="px-6 py-4 text-center text-gray-500">No data available</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const WS_URL = 'ws://localhost:4001'; // Update to server IP (e.g., ws://192.168.x.x:4001) for remote access
    let latestShipsData = null;

    function updateStatus(message, color) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `mb-4 text-lg font-semibold text-${color}-700`;
    }

    function updateTable() {
      const tbody = document.getElementById('shipTableBody');
      tbody.innerHTML = ''; // Clear table

      if (!latestShipsData || !latestShipsData.ships || latestShipsData.ships.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">No data available</td></tr>';
        return;
      }

      // Flatten gps_data for table rows
      const flattenedShips = latestShipsData.ships.flatMap(ship =>
        ship.gps_data.map(gpsEntry => ({
          ship_id: ship.ship_id,
          gps: gpsEntry.gps,
          latitude: gpsEntry.latitude,
          longitude: gpsEntry.longitude,
          altitude: gpsEntry.altitude,
          speed: gpsEntry.speed,
          satellites: gpsEntry.satellites,
          timestamp: ship.timestamp,
          heading: ship.heading,
          device_id: ship.device_id
        }))
      );

      console.log('Updating table with:', flattenedShips);

      flattenedShips.forEach(ship => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.ship_id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.gps}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.latitude.toFixed(6)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.longitude.toFixed(6)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.altitude !== null ? ship.altitude.toFixed(2) : 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.speed !== null ? ship.speed.toFixed(2) : 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.heading !== null ? ship.heading.toFixed(1) : 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.satellites || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.timestamp}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ship.device_id || 'N/A'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function initWebSocket() {
      const ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        updateStatus('Connected to WebSocket server', 'green');
        console.log('WebSocket connected');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('Received:', data);
          if (data.type === 'shipsUpdate') {
            latestShipsData = data;
            updateTable(); // Update immediately
          }
        } catch (error) {
          console.error('Error parsing message:', error);
          updateStatus('Error parsing WebSocket data', 'red');
        }
      };

      ws.onclose = () => {
        updateStatus('Disconnected from WebSocket server', 'red');
        console.log('WebSocket disconnected');
        setTimeout(initWebSocket, 5000); // Reconnect after 5 seconds
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('WebSocket error occurred', 'red');
      };
    }

    // Initialize WebSocket and update table every 5 seconds
    initWebSocket();
    setInterval(updateTable, 5000);
  </script>
</body>
</html>